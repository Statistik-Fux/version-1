<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Handball Statistik</title>

<!-- Cache verhindern -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<style>
body { font-family: Arial, sans-serif; margin: 0; background-color: #fff; }
body::before, body::after {
    content: ""; position: fixed; top: 50%; transform: translateY(-50%);
    width: 70vw; height: 90vh; background-repeat: no-repeat; background-position: center;
    background-size: contain; opacity: 0.15; filter: blur(0.5px);
    z-index: -1; pointer-events: none;
}
body::before { left: 15%; }
body::after { right: 15%; }
h1, h2 { text-align: center; margin-bottom: 15px; }
#setup { background: rgba(255, 255, 255, 0.6); padding: 20px; border-radius: 12px;
    max-width: 500px; margin: 30px auto; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
#opponent, #teamSelect { font-size: 1.1em; padding: 12px; width: 100%; margin-bottom: 20px;
    border: 1px solid #ccc; border-radius: 8px; background-color: rgba(255,255,255,0.85);
    transition: border-color 0.3s, box-shadow 0.3s; color: black;
}
#opponent:focus, #teamSelect:focus { outline: none; border-color: #009688; box-shadow: 0 0 5px rgba(0,150,136,0.5); }
#player-selection { display: flex; gap: 10px; flex-wrap: nowrap; justify-content: space-between; }
#player-selection .column { width: 48%; display: flex; flex-direction: column; gap: 8px; }
#player-selection label { cursor: pointer; font-size: 1em; padding: 4px 0; }
#player-selection input[type="checkbox"] { margin-right: 6px; transform: scale(1.2); }
.add-player-container { margin-top: 15px; display: flex; gap: 5px; }
.add-player-container input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 6px; }
.add-player-container select { margin-left:5px; padding:6px; border-radius:6px; border:1px solid #ccc; }
.add-player-container button { padding: 8px 12px; border: none; border-radius: 6px;
    background-color: #009688; color: white; cursor: pointer; font-size: 1em; }
.add-player-container button:hover { background-color: #00796b; }
.start-btn {
    font-size: 1.3em; padding: 12px 15px; background: linear-gradient(90deg, #009688, #26a69a);
    color: white; border: none; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 20px;
    transition: background 0.3s, transform 0.1s;
}
.start-btn:hover { background: linear-gradient(90deg, #00796b, #26a69a); }
.start-btn:active { transform: scale(0.98); }
.player-card { border-radius: 8px; padding: 10px; margin: 10px; flex: 1; min-width: 250px;
    background: white; box-shadow: 0 3px 8px rgba(0,0,0,0.05); }
.player-name { font-weight: bold; font-size: 1.4em; text-align: center; margin-bottom: 10px; }
.grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; padding: 10px; }
.btn { width: 31%; padding: 8px; margin: 2px 1%; border: none; cursor: pointer;
    font-size: 0.9em; border-radius: 6px; user-select: none; }
.positive { background-color: #d4edda; }
.negative { background-color: #f8d7da; }
.full-width { width: 98%; }
table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: white; font-size: 0.9em; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
th { background: #f0f0f0; }
.thick-separator { border-left: 3px solid black !important; }
.export-buttons { margin-top: 20px; text-align: center; }
.hidden { display: none; }
@media (max-width: 768px) {
    .btn { width: 48%; font-size: 0.85em; padding: 6px; }
    .player-card { min-width: unset; width: 100%; }
    #player-selection { flex-direction: column; }
    #player-selection .column { width: 100%; }
    table { font-size: 0.8em; }
}
</style>
</head>
<body>
    <main id="setup">
    <h1>Willkommen!</h1>
    <input type="text" id="opponent" placeholder="Gegner eingeben">
    <select id="teamSelect">
        <option value="Fux2">Fux2</option>
        <option value="FuxA">FuxA</option>
    </select>

    <section id="player-selection">
        <div class="column" id="col1"></div>
        <div class="column" id="col2"></div>
    </section>

    <div class="add-player-container">
        <input type="text" id="newPlayerName" placeholder="Spielername eingeben">
        <select id="newPlayerCategory">
            <option value="Rückraum">Rückraum</option>
            <option value="Außen">Außen</option>
            <option value="Kreis">Kreis</option>
            <option value="Torhüter">Torhüter</option>
        </select>
        <button type="button" id="addPlayerBtn">+</button>
    </div>

    <button class="start-btn" id="startBtn">Start</button>
</main>

<h1 id="headline" class="hidden"></h1>
<div id="players" class="grid"></div>

<div class="export-buttons hidden" id="playerExport">
    <button data-export="excel" data-table="playerTable">Export Excel</button>
    <button data-export="pdf" data-table="playerTable">Export PDF</button>
</div>
<div id="playerStats"></div>

<div class="export-buttons hidden" id="teamExport">
    <button data-export="excel" data-table="teamTable">Export Excel</button>
    <button data-export="pdf" data-table="teamTable">Export PDF</button>
</div>
<div id="teamStats"></div>

<!-- Bibliotheken für Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
(() => {
    const cb = Date.now();
    const col1 = document.getElementById("col1");
    const col2 = document.getElementById("col2");
    const startBtn = document.getElementById("startBtn");
    const teamSelect = document.getElementById("teamSelect");
    const addPlayerBtn = document.getElementById("addPlayerBtn");
    const newPlayerNameInput = document.getElementById("newPlayerName");
    const newPlayerCategorySelect = document.getElementById("newPlayerCategory");

    let currentOpponent = "";

    const teams = {
        Fux2: ["Julian Kusche","Gabriel Kofler","Lauro Pichiri","Felix Bernkop-Schnürch","Rune Laskowski","Lucas Mohr","Navi Yatawarage","William Reichardt","Justin Wollny","Jan Grüner","Dominik Kupiec","Lennart Steltner","Luca Thiel","Tim Schröder","Jonas Kofler","Till Braren","Pius Joppich","Norman Glamann"],
        FuxA: ["Leo Nowak","Simon Poppe","Fritz Parke","Fynn Paulicks","Filip Dominikovic","Leo Tautenhahn","Antonio D'Incecco","Noah Skei","Simon Sirot","Albert Schmidt","Gabor Zeuch","Christopher Losch","Davide Babini","Tillman Stark","Henning Lahuis","Ole Krake","Matteo Agistonelli"]
    };

    const categories = {
        Fux2: [...Array(8).fill("Rückraum"), ...Array(5).fill("Außen"), ...Array(3).fill("Kreis"), ...Array(2).fill("Torhüter")],
        FuxA: [...Array(8).fill("Rückraum"), ...Array(4).fill("Außen"), ...Array(2).fill("Kreis"), ...Array(3).fill("Torhüter")]
    };

    let playerNames = [...teams.Fux2];
    let playerCategories = [...categories.Fux2];

    const actionsPositive = [
        {key:"KM_pos",label:"KM"},
        {key:"DBR_pos",label:"DBR"},
        {key:"AUSSEN_pos",label:"Außen"},
        {key:"NAH_pos",label:"NAH"},
        {key:"FERN_pos",label:"FERN"},
        {key:"TGS_pos",label:"TGS"},
        {key:"LT_pos",label:"Leeres"},
        {key:"7M_pos",label:"7M"}
    ];
    const actionsNegative = [
        {key:"KM_neg",label:"KM"},
        {key:"DBR_neg",label:"DBR"},
        {key:"AUSSEN_neg",label:"Außen"},
        {key:"NAH_neg",label:"NAH"},
        {key:"FERN_neg",label:"FERN"},
        {key:"TGS_neg",label:"TGS"},
        {key:"LT_neg",label:"Leeres"},
        {key:"7M_neg",label:"7M"},
        {key:"TF_neg",label:"TF"}
    ];

    let playersData = {};
    let pressTimer, longPressActive, activeTouch;

    window.addEventListener("load", () => {
        document.styleSheets[0].cssRules[1].style.backgroundImage = `url('logo.png.JPG?cb=${cb}')`;
        document.styleSheets[0].cssRules[2].style.backgroundImage = `url('logo.png.JPG?cb=${cb}')`;
        renderPlayerCheckboxes();
    });

    function renderPlayerCheckboxes() {
        col1.innerHTML = ""; col2.innerHTML = "";
        playerNames.forEach((name,i) => {
            const label = document.createElement("label");
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox"; checkbox.value = i + 1;
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(` ${name}`));
            (i < Math.ceil(playerNames.length / 2) ? col1 : col2).appendChild(label);
        });
    }

    teamSelect.addEventListener("change", () => {
        playerNames = [...teams[teamSelect.value]];
        playerCategories = [...categories[teamSelect.value]];
        renderPlayerCheckboxes();
    });

    addPlayerBtn.addEventListener("click", () => {
        const n = newPlayerNameInput.value.trim();
        const cat = newPlayerCategorySelect.value;
        if(n){
            let insertIndex = -1;
            for(let i=playerCategories.length-1;i>=0;i--){
                if(playerCategories[i]===cat){ insertIndex=i+1; break; }
            }
            if(insertIndex === -1) insertIndex = playerCategories.length;
            playerNames.splice(insertIndex,0,n);
            playerCategories.splice(insertIndex,0,cat);
            renderPlayerCheckboxes();
            newPlayerNameInput.value="";
        }
    });

    function validateAndStart() {
        const opponent = document.getElementById("opponent").value.trim();
        const selected = Array.from(document.querySelectorAll("#player-selection input:checked"));
        if (!opponent || selected.length < 7) {
            alert("Bitte korrigieren:\n- Gegner eingeben\n- Mindestens 7 Spieler auswählen");
            return;
        }
        currentOpponent = opponent;
        startGame(opponent, selected.map(cb => parseInt(cb.value)));
    }

    function startGame(opponent, selectedPlayers) {
        document.getElementById("headline").innerText = `Statistik vs ${opponent}`;
        document.getElementById("setup").classList.add("hidden");
        document.getElementById("headline").classList.remove("hidden");
        document.getElementById("playerExport").classList.remove("hidden");
        document.getElementById("teamExport").classList.remove("hidden");
        const playersDiv = document.getElementById("players");
        playersDiv.innerHTML = "";

        selectedPlayers.forEach(num => {
            playersData[num] = {};
            [...actionsPositive, ...actionsNegative].forEach(a => {
                playersData[num][a.key] = 0;
                playersData[num][a.key + "_temp"] = 0;
            });

            const card = document.createElement("div");
            card.className = "player-card";
            const nameDiv = document.createElement("div");
            nameDiv.className = "player-name";
            nameDiv.textContent = playerNames[num - 1];
            card.appendChild(nameDiv);

            [...actionsPositive, ...actionsNegative].forEach((a, idx) => {
                const btn = document.createElement("button");
                btn.className = `btn ${idx < actionsPositive.length ? "positive" : "negative"}`;
                if (a.key.startsWith("TF") && idx >= actionsPositive.length) btn.classList.add("full-width");
                btn.textContent = `${a.label} (0)`;

                const isFieldPlayer = playerCategories[num - 1] !== "Torhüter";
                const canAddTempo = (idx < actionsPositive.length || a.key === "TF_neg") && isFieldPlayer;

                let clickTimer = null, dblClickActive = false;

                const startPress = () => {
                    longPressActive = false;
                    pressTimer = setTimeout(() => {
                        playersData[num][a.key] = Math.max(0, playersData[num][a.key] - 1);
                        btn.textContent = formatBtnText(num, a);
                        updateTables();
                        longPressActive = true;
                    }, 500);
                };

                const endPress = () => {
                    clearTimeout(pressTimer);
                    if (!longPressActive && !dblClickActive) {
                        if (clickTimer) clearTimeout(clickTimer);
                        clickTimer = setTimeout(() => {
                            playersData[num][a.key]++;
                            btn.textContent = formatBtnText(num, a);
                            updateTables();
                            clickTimer = null;
                        }, 250);
                    }
                };

                btn.addEventListener("dblclick", e => {
                    dblClickActive = true;
                    if (clickTimer) clearTimeout(clickTimer);
                    if (canAddTempo) {
                        playersData[num][a.key]++;
                        playersData[num][a.key + "_temp"]++;
                        btn.textContent = formatBtnText(num, a);
                        updateTables();
                    }
                    setTimeout(() => dblClickActive = false, 300);
                });

                btn.addEventListener("mousedown", e => { if (!activeTouch) startPress(); });
                btn.addEventListener("mouseup", e => { if (!activeTouch) endPress(); });
                btn.addEventListener("mouseleave", () => clearTimeout(pressTimer));
                btn.addEventListener("touchstart", e => { activeTouch = true; startPress(); e.preventDefault(); });
                btn.addEventListener("touchend", e => { endPress(); setTimeout(() => activeTouch = false, 300); e.preventDefault(); });
                btn.addEventListener("touchcancel", () => clearTimeout(pressTimer));

                card.appendChild(btn);

                if (idx === actionsPositive.length - 1) {
                    const sep = document.createElement("div");
                    sep.style.borderBottom = "3px solid black";
                    sep.style.margin = "5px 0";
                    card.appendChild(sep);
                }
            });
            playersDiv.appendChild(card);
        });
        updateTables();
    }

    function formatBtnText(num, a) {
        const val = playersData[num][a.key];
        const temp = playersData[num][a.key + "_temp"];
        return temp > 0 ? `${a.label} (${val} (${temp}))` : `${a.label} (${val})`;
    }

    // Eventlistener Start
    startBtn.addEventListener("click", validateAndStart);

    // Tabellen-Update und Export
    // ... (Hier kommt der gesamte updateTables und Exportcode, unverändert aus deinem Original) 
})();
</script>
