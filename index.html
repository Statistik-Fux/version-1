<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Handball Statistik</title>

<!-- Cache verhindern -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<style>
body { font-family: Arial, sans-serif; margin: 0; background-color: #fff; }
body::before, body::after {
    content: ""; position: fixed; top: 50%; transform: translateY(-50%);
    width: 70vw; height: 90vh; background-repeat: no-repeat; background-position: center;
    background-size: contain; opacity: 0.15; filter: blur(0.5px);
    z-index: -1; pointer-events: none;
}
body::before { left: 15%; }
body::after { right: 15%; }

h1, h2 { text-align: center; margin-bottom: 15px; }

#setup {
    background: rgba(255, 255, 255, 0.6); padding: 20px; border-radius: 12px;
    max-width: 500px; margin: 30px auto; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
#opponent, #teamSelect {
    font-size: 1.1em; padding: 12px; width: 100%; margin-bottom: 20px;
    border: 1px solid #ccc; border-radius: 8px; background-color: rgba(255,255,255,0.85);
}
#player-selection { display: flex; gap: 10px; justify-content: space-between; }
#player-selection .column { width: 48%; display: flex; flex-direction: column; gap: 8px; }

.add-player-container { margin-top: 15px; display: flex; gap: 5px; }
.add-player-container input, .add-player-container select {
    flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 6px;
}
.add-player-container button {
    padding: 8px 12px; border: none; border-radius: 6px;
    background-color: #009688; color: white; cursor: pointer;
}
.start-btn {
    font-size: 1.3em; padding: 12px 15px;
    background: linear-gradient(90deg, #009688, #26a69a);
    color: white; border: none; border-radius: 8px; cursor: pointer;
    width: 100%; margin-top: 20px;
}
.player-card { border-radius: 8px; padding: 10px; margin: 10px; background: white;
    box-shadow: 0 3px 8px rgba(0,0,0,0.05); min-width: 250px; }
.player-name { font-weight: bold; font-size: 1.4em; text-align: center; margin-bottom: 10px; }
.grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; padding: 10px; }

.btn { width: 31%; padding: 8px; margin: 2px 1%; border: none; cursor: pointer;
    font-size: 0.9em; border-radius: 6px; user-select: none; }
.positive { background-color: #d4edda; }
.negative { background-color: #f8d7da; }
.full-width { width: 98%; }

table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: white; font-size: 0.9em; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
th { background: #f0f0f0; }
.thick-separator { border-left: 3px solid black !important; }
.export-buttons { margin-top: 20px; text-align: center; }
.hidden { display: none; }

@media (max-width: 768px) {
    .btn { width: 48%; font-size: 0.85em; padding: 6px; }
    .player-card { width: 100%; }
}
</style>
</head>
<body>
<main id="setup">
<h1>Willkommen!</h1>
<input type="text" id="opponent" placeholder="Gegner eingeben">
<select id="teamSelect">
    <option value="Fux2">Fux2</option>
    <option value="FuxA">FuxA</option>
</select>
<section id="player-selection">
    <div class="column" id="col1"></div>
    <div class="column" id="col2"></div>
</section>
<div class="add-player-container">
    <input type="text" id="newPlayerName" placeholder="Spielername eingeben">
    <select id="newPlayerCategory">
        <option value="Rückraum">Rückraum</option>
        <option value="Außen">Außen</option>
        <option value="Kreis">Kreis</option>
        <option value="Torhüter">Torhüter</option>
    </select>
    <button type="button" id="addPlayerBtn">+</button>
</div>
<button class="start-btn" id="startBtn">Start</button>
</main>

<h1 id="headline" class="hidden"></h1>
<div id="players" class="grid"></div>

<div class="export-buttons hidden" id="playerExport">
    <button id="exportExcelPlayer">Export Excel</button>
    <button id="exportPdfPlayer">Export PDF</button>
</div>
<div id="playerStats"></div>

<div class="export-buttons hidden" id="teamExport">
    <button id="exportExcelTeam">Export Excel</button>
</div>
<div id="teamStats"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
(() => {
    const cb = Date.now();
    const col1 = document.getElementById("col1");
    const col2 = document.getElementById("col2");
    const teamSelect = document.getElementById("teamSelect");
    const addPlayerBtn = document.getElementById("addPlayerBtn");
    const newPlayerNameInput = document.getElementById("newPlayerName");
    const newPlayerCategorySelect = document.getElementById("newPlayerCategory");
    const startBtn = document.getElementById("startBtn");

    let currentOpponent = "";
    let playersData = {};

    const teams = {
        Fux2: ["Julian Kusche","Gabriel Kofler","Lauro Pichiri","Felix Bernkop-Schnürch","Rune Laskowski","Lucas Mohr","Navi Yatawarage","William Reichardt","Justin Wollny","Jan Grüner","Dominik Kupiec","Lennart Steltner","Luca Thiel","Tim Schröder","Jonas Kofler","Till Braren","Pius Joppich","Norman Glamann"],
        FuxA: ["Leo Nowak","Simon Poppe","Fritz Parke","Fynn Paulicks","Filip Dominikovic","Leo Tautenhahn","Antonio D'Incecco","Noah Skei","Simon Sirot","Albert Schmidt","Gabor Zeuch","Christopher Losch","Davide Babini","Tillman Stark","Henning Lahuis","Ole Krake","Matteo Agistonelli"]
    };

    const categories = {
        Fux2: [...Array(8).fill("Rückraum"),...Array(5).fill("Außen"),...Array(3).fill("Kreis"),...Array(2).fill("Torhüter")],
        FuxA: [...Array(8).fill("Rückraum"),...Array(4).fill("Außen"),...Array(2).fill("Kreis"),...Array(3).fill("Torhüter")]
    };

    let playerNames = [...teams.Fux2];
    let playerCategories = [...categories.Fux2];

    // --- Aktionen ---
    const actionsPositive = [
        {key:"KM_pos",label:"KM"},{key:"DBR_pos",label:"DBR"},{key:"AUSSEN_pos",label:"Außen"},
        {key:"NAH_pos",label:"NAH"},{key:"FERN_pos",label:"FERN"},{key:"TGS_pos",label:"TGS"},
        {key:"LT_pos",label:"Leeres"},{key:"7M_pos",label:"7M"}
    ];
    const actionsNegative = [
        {key:"KM_neg",label:"KM"},{key:"DBR_neg",label:"DBR"},{key:"AUSSEN_neg",label:"Außen"},
        {key:"NAH_neg",label:"NAH"},{key:"FERN_neg",label:"FERN"},{key:"TGS_neg",label:"TGS"},
        {key:"LT_neg",label:"Leeres"},{key:"7M_neg",label:"7M"},{key:"TF_neg",label:"TF"}
    ];

    // --- Checkboxen anzeigen ---
    window.addEventListener("load", () => {
        document.styleSheets[0].cssRules[1].style.backgroundImage = `url('logo.png.JPG?cb=${cb}')`;
        document.styleSheets[0].cssRules[2].style.backgroundImage = `url('logo.png.JPG?cb=${cb}')`;
        renderPlayerCheckboxes();
    });

    function renderPlayerCheckboxes() {
        col1.innerHTML = ""; col2.innerHTML = "";
        playerNames.forEach((name,i)=>{
            const label=document.createElement("label");
            const checkbox=document.createElement("input");
            checkbox.type="checkbox"; checkbox.value=i+1;
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(" "+name));
            (i<Math.ceil(playerNames.length/2)?col1:col2).appendChild(label);
        });
    }

    // --- Team wechseln ---
    teamSelect.addEventListener("change",()=>{
        playerNames=[...teams[teamSelect.value]];
        playerCategories=[...categories[teamSelect.value]];
        renderPlayerCheckboxes();
    });

    // --- Spieler hinzufügen ---
    addPlayerBtn.addEventListener("click",()=>{
        const n=newPlayerNameInput.value.trim();
        const cat=newPlayerCategorySelect.value;
        if(!n) return;
        let insertIndex=playerCategories.findLastIndex(c=>c===cat);
        if(insertIndex===-1) insertIndex=playerCategories.length-1; else insertIndex++;
        playerNames.splice(insertIndex,0,n);
        playerCategories.splice(insertIndex,0,cat);
        renderPlayerCheckboxes();
        newPlayerNameInput.value="";
    });

    // --- Startbutton ---
    startBtn.addEventListener("click",()=>{
        const opponent=document.getElementById("opponent").value.trim();
        const selected=Array.from(document.querySelectorAll("#player-selection input:checked"));
        if(!opponent || selected.length<7){
            alert("Bitte Gegner eingeben und mindestens 7 Spieler auswählen!");
            return;
        }
        currentOpponent=opponent;
        startGame(opponent,selected.map(cb=>parseInt(cb.value)));
    });
    function startGame(opponent,selectedPlayers){
        document.getElementById("headline").innerText=`Statistik vs ${opponent}`;
        document.getElementById("setup").classList.add("hidden");
        document.getElementById("headline").classList.remove("hidden");
        document.getElementById("playerExport").classList.remove("hidden");
        document.getElementById("teamExport").classList.remove("hidden");

        const playersDiv=document.getElementById("players");
        playersDiv.innerHTML="";

        selectedPlayers.forEach(num=>{
            playersData[num]={};
            [...actionsPositive,...actionsNegative].forEach(a=>{
                playersData[num][a.key]=0;
                playersData[num][a.key+"_temp"]=0; // Tempo-Aktion
            });

            const card=document.createElement("div");
            card.className="player-card";
            const nameDiv=document.createElement("div");
            nameDiv.className="player-name";
            nameDiv.textContent=playerNames[num-1];
            card.appendChild(nameDiv);

            // Buttons erzeugen
            [...actionsPositive,...actionsNegative].forEach((a,idx)=>{
                const btn=document.createElement("button");
                btn.className=`btn ${idx<actionsPositive.length?"positive":"negative"}`;
                if(a.key==="TF_neg") btn.classList.add("full-width");
                btn.dataset.player=num;
                btn.dataset.key=a.key;
                updateButtonText(btn,num,a.key);

                let clickTimer=null;
                let pressTimer=null;
                let longPressTriggered=false;

                const startPress=()=>{
                    longPressTriggered=false;
                    pressTimer=setTimeout(()=>{
                        longPressTriggered=true;
                        decrementAction(num,a.key);
                        updateAll();
                    },600);
                };
                const cancelPress=()=>clearTimeout(pressTimer);

                if(window.PointerEvent){
                    btn.addEventListener("pointerdown",startPress);
                    btn.addEventListener("pointerup",cancelPress);
                    btn.addEventListener("pointercancel",cancelPress);
                    btn.addEventListener("pointerleave",cancelPress);
                }else{
                    btn.addEventListener("mousedown",startPress);
                    btn.addEventListener("mouseup",cancelPress);
                    btn.addEventListener("mouseleave",cancelPress);
                    btn.addEventListener("touchstart",()=>startPress(),{passive:true});
                    btn.addEventListener("touchend",cancelPress);
                    btn.addEventListener("touchcancel",cancelPress);
                }

                // Klick / Doppelklick
                btn.addEventListener("click",()=>{
                    if(longPressTriggered){ longPressTriggered=false; return; }
                    if(clickTimer==null){
                        clickTimer=setTimeout(()=>{
                            handleSingleClick(num,a.key);
                            clickTimer=null;
                        },250);
                    } else {
                        clearTimeout(clickTimer);
                        clickTimer=null;
                        handleDoubleClick(num,a.key);
                    }
                });

                card.appendChild(btn);
                if(idx===actionsPositive.length-1){
                    const sep=document.createElement("div");
                    sep.style.borderBottom="3px solid black";
                    sep.style.margin="5px 0";
                    card.appendChild(sep);
                }
            });

            playersDiv.appendChild(card);
        });

        updateAll();
    }

    function decrementAction(num,key){
        if(playersData[num][key+"_temp"]>0){
            playersData[num][key+"_temp"]--;
            playersData[num][key]--;
        } else if(playersData[num][key]>0){
            playersData[num][key]--;
        }
    }

    function handleSingleClick(num,key){
        playersData[num][key]++;
        updateAll();
    }

    function handleDoubleClick(num,key){
        const cat=playerCategories[num-1];
        const isPositive=actionsPositive.some(a=>a.key===key);
        const isTF=key==="TF_neg";
        if(isPositive && cat!=="Torhüter"){
            playersData[num][key]++;
            playersData[num][key+"_temp"]++; // Tempo-Tor
        } else if(isTF){
            // Tempo-TF (zählt nicht in Tempotore)
            playersData[num][key]++;
            playersData[num][key+"_temp"]++;
        } else {
            playersData[num][key]++;
        }
        updateAll();
    }

    function updateButtonText(btn,num,key){
        const val=playersData[num][key]||0;
        btn.textContent=`${getLabel(key)} (${val})`;
    }

    function getLabel(key){
        const a=[...actionsPositive,...actionsNegative].find(x=>x.key===key);
        return a?a.label:key;
    }

    function updateAll(){
        document.querySelectorAll(".btn").forEach(btn=>{
            const p=btn.dataset.player;
            const k=btn.dataset.key;
            updateButtonText(btn,parseInt(p),k);
        });
        updateTables();
    }

    function updateTables(){
        const buildTable=(id,header1,rows,extra="")=>{
            const sepIndex=actionsPositive.length;
            let headerRow=`<tr><th>${header1}</th>`;
            actionsPositive.forEach(a=>headerRow+=`<th>${a.label}</th>`);
            actionsNegative.forEach((a,i)=>headerRow+=`<th class="${i===0?"thick-separator":""}">${a.label}</th>`);
            headerRow+=`<th>WQ</th><th>WQ inkl. TF</th>${extra}</tr>`;
            return `<table id="${id}">${headerRow}${rows}</table>`;
        };

        // Spielerstatistik
        let playerRows="";
        let lastCat=null;
        Object.keys(playersData).forEach(num=>{
            const cat=playerCategories[num-1];
            if(lastCat && lastCat!==cat)
                playerRows+=`<tr><td colspan="${actionsPositive.length+actionsNegative.length+3}"></td></tr>`;
            lastCat=cat;

            const posSum=actionsPositive.reduce((s,a)=>s+(playersData[num][a.key]||0),0);
            const negSumExTF=actionsNegative.filter(a=>a.key!=="TF_neg").reduce((s,a)=>s+(playersData[num][a.key]||0),0);
            const negSumAll=actionsNegative.reduce((s,a)=>s+(playersData[num][a.key]||0),0);
            const wq=posSum+negSumExTF>0?(posSum/(posSum+negSumExTF)*100).toFixed(1)+"%":"-";
            const wqTF=posSum+negSumAll>0?(posSum/(posSum+negSumAll)*100).toFixed(1)+"%":"-";

            let row=`<tr><td>${playerNames[num-1]}</td>`;
            actionsPositive.forEach(a=>row+=`<td>${playersData[num][a.key]||0}</td>`);
            actionsNegative.forEach((a,i)=>row+=`<td class="${i===0?"thick-separator":""}">${playersData[num][a.key]||0}</td>`);
            row+=`<td>${wq}</td><td>${wqTF}</td></tr>`;
            playerRows+=row;
        });

        // Teamstatistik
        const teamCats=["Rückraum","Außen","Kreis","Torhüter"];
        let teamRows="";
        let totalRow="";

        const fieldCats=["Rückraum","Außen","Kreis"];
        const fieldNums=Object.keys(playersData).filter(n=>fieldCats.includes(playerCategories[n-1]));

        if(fieldNums.length>0){
            let catSums={};
            [...actionsPositive,...actionsNegative].forEach(a=>{
                catSums[a.key]=fieldNums.reduce((s,n)=>s+(playersData[n][a.key]||0),0);
            });
            const posSum=actionsPositive.reduce((s,a)=>s+catSums[a.key],0);
            const negSumExTF=actionsNegative.filter(a=>a.key!=="TF_neg").reduce((s,a)=>s+catSums[a.key],0);
            const negSumAll=actionsNegative.reduce((s,a)=>s+catSums[a.key],0);
            const tempoSum=fieldNums.reduce((s,n)=>s+actionsPositive.reduce((t,a)=>t+(playersData[n][a.key+"_temp"]||0),0),0);
            const wq=posSum+negSumExTF>0?(posSum/(posSum+negSumExTF)*100).toFixed(1)+"%":"-";
            const wqTF=posSum+negSumAll>0?(posSum/(posSum+negSumAll)*100).toFixed(1)+"%":"-";
            totalRow=`<tr><td><b>Gesamt (Feldspieler)</b></td>`+
                actionsPositive.map(a=>`<td><b>${catSums[a.key]}</b></td>`).join("")+
                actionsNegative.map((a,i)=>`<td class="${i===0?"thick-separator":""}"><b>${catSums[a.key]}</b></td>`).join("")+
                `<td><b>${wq}</b></td><td><b>${wqTF}</b></td><td><b>${tempoSum}</b></td></tr>`;
        }

        teamCats.forEach(cat=>{
            const nums=Object.keys(playersData).filter(n=>playerCategories[n-1]===cat);
            if(nums.length===0)return;
            let catSums={};
            [...actionsPositive,...actionsNegative].forEach(a=>{
                catSums[a.key]=nums.reduce((s,n)=>s+(playersData[n][a.key]||0),0);
            });
            const posSum=actionsPositive.reduce((s,a)=>s+catSums[a.key],0);
            const negSumExTF=actionsNegative.filter(a=>a.key!=="TF_neg").reduce((s,a)=>s+catSums[a.key],0);
            const negSumAll=actionsNegative.reduce((s,a)=>s+catSums[a.key],0);
            const tempoSum=nums.reduce((s,n)=>s+actionsPositive.reduce((t,a)=>t+(playersData[n][a.key+"_temp"]||0),0),0);
            const wq=posSum+negSumExTF>0?(posSum/(posSum+negSumExTF)*100).toFixed(1)+"%":"-";
            const wqTF=posSum+negSumAll>0?(posSum/(posSum+negSumAll)*100).toFixed(1)+"%":"-";
            teamRows+=`<tr><td>${cat}</td>`+
                actionsPositive.map(a=>`<td>${catSums[a.key]}</td>`).join("")+
                actionsNegative.map((a,i)=>`<td class="${i===0?"thick-separator":""}">${catSums[a.key]}</td>`).join("")+
                `<td>${wq}</td><td>${wqTF}</td><td>${tempoSum}</td></tr>`;
        });

        document.getElementById("playerStats").innerHTML=buildTable("playerTable","Spieler",playerRows);
        document.getElementById("teamStats").innerHTML=buildTable("teamTable","Kategorie",totalRow+teamRows,"<th>Tempotore</th>");
    }
    // ---- Export CSV ----
    document.getElementById("playerExport").addEventListener("click",(e)=>{
        if(e.target.dataset.export==="pdf"){
            exportPDF("playerTable","Spieler_Statistik_"+currentOpponent+".pdf");
            return;
        }
        let csv="Spieler,"+
            actionsPositive.map(a=>a.label).join(",")+","+
            actionsNegative.map(a=>a.label).join(",")+
            ",WQ,WQ inkl. TF,Tempotore\n";
        Object.keys(playersData).forEach(num=>{
            const posSum=actionsPositive.reduce((s,a)=>s+(playersData[num][a.key]||0),0);
            const negSumExTF=actionsNegative.filter(a=>a.key!=="TF_neg").reduce((s,a)=>s+(playersData[num][a.key]||0),0);
            const negSumAll=actionsNegative.reduce((s,a)=>s+(playersData[num][a.key]||0),0);
            const wq=posSum+negSumExTF>0?(posSum/(posSum+negSumExTF)*100).toFixed(1)+"%":"-";
            const wqTF=posSum+negSumAll>0?(posSum/(posSum+negSumAll)*100).toFixed(1)+"%":"-";
            const totalTempo=actionsPositive.reduce((t,a)=>t+(playersData[num][a.key+"_temp"]||0),0);
            csv+=`${playerNames[num-1]},`+
                actionsPositive.map(a=>playersData[num][a.key]||0).join(",")+","+
                actionsNegative.map(a=>playersData[num][a.key]||0).join(",")+","+
                `${wq},${wqTF},${totalTempo}\n`;
        });
        downloadCSV(csv,"Spieler_Statistik_"+currentOpponent+".csv");
    });

    document.getElementById("teamExport").addEventListener("click",(e)=>{
        if(e.target.dataset.export==="pdf"){
            exportPDF("teamTable","Team_Statistik_"+currentOpponent+".pdf");
            return;
        }
        const teamCats=["Rückraum","Außen","Kreis","Torhüter"];
        let csv="Kategorie,"+
            actionsPositive.map(a=>a.label).join(",")+","+
            actionsNegative.map(a=>a.label).join(",")+
            ",WQ,WQ inkl. TF,Tempotore\n";

        const fieldCats=["Rückraum","Außen","Kreis"];
        const fieldNums=Object.keys(playersData).filter(n=>fieldCats.includes(playerCategories[n-1]));
        if(fieldNums.length>0){
            let catSums={};
            [...actionsPositive,...actionsNegative].forEach(a=>{
                catSums[a.key]=fieldNums.reduce((s,n)=>s+(playersData[n][a.key]||0),0);
            });
            const posSum=actionsPositive.reduce((s,a)=>s+catSums[a.key],0);
            const negSumExTF=actionsNegative.filter(a=>a.key!=="TF_neg").reduce((s,a)=>s+catSums[a.key],0);
            const negSumAll=actionsNegative.reduce((s,a)=>s+catSums[a.key],0);
            const tempoSum=fieldNums.reduce((s,n)=>s+actionsPositive.reduce((t,a)=>t+(playersData[n][a.key+"_temp"]||0),0),0);
            const wq=posSum+negSumExTF>0?(posSum/(posSum+negSumExTF)*100).toFixed(1)+"%":"-";
            const wqTF=posSum+negSumAll>0?(posSum/(posSum+negSumAll)*100).toFixed(1)+"%":"-";
            csv+=`Gesamt (Feldspieler),`+
                actionsPositive.map(a=>catSums[a.key]).join(",")+","+
                actionsNegative.map(a=>catSums[a.key]).join(",")+","+
                `${wq},${wqTF},${tempoSum}\n`;
        }

        teamCats.forEach(cat=>{
            const nums=Object.keys(playersData).filter(n=>playerCategories[n-1]===cat);
            if(nums.length===0)return;
            let catSums={};
            [...actionsPositive,...actionsNegative].forEach(a=>{
                catSums[a.key]=nums.reduce((s,n)=>s+(playersData[n][a.key]||0),0);
            });
            const posSum=actionsPositive.reduce((s,a)=>s+catSums[a.key],0);
            const negSumExTF=actionsNegative.filter(a=>a.key!=="TF_neg").reduce((s,a)=>s+catSums[a.key],0);
            const negSumAll=actionsNegative.reduce((s,a)=>s+catSums[a.key],0);
            const tempoSum=nums.reduce((s,n)=>s+actionsPositive.reduce((t,a)=>t+(playersData[n][a.key+"_temp"]||0),0),0);
            const wq=posSum+negSumExTF>0?(posSum/(posSum+negSumExTF)*100).toFixed(1)+"%":"-";
            const wqTF=posSum+negSumAll>0?(posSum/(posSum+negSumAll)*100).toFixed(1)+"%":"-";
            csv+=`${cat},`+
                actionsPositive.map(a=>catSums[a.key]).join(",")+","+
                actionsNegative.map(a=>catSums[a.key]).join(",")+","+
                `${wq},${wqTF},${tempoSum}\n`;
        });
        downloadCSV(csv,"Team_Statistik_"+currentOpponent+".csv");
    });

    function downloadCSV(content,filename){
        const blob=new Blob([content],{type:"text/csv;charset=utf-8;"});
        const url=URL.createObjectURL(blob);
        const a=document.createElement("a");
        a.href=url; a.download=filename;
        a.click();
        URL.revokeObjectURL(url);
    }

    // ---- PDF Export ----
    function exportPDF(tableId,filename){
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({orientation:"landscape"});
        doc.setFontSize(10);
        const table = document.getElementById(tableId);
        const columns=[];
        const rows=[];
        table.querySelectorAll("thead tr th").forEach(th=>columns.push({header:th.textContent,dataKey:th.textContent}));
        table.querySelectorAll("tbody tr").forEach(tr=>{
            const row={};
            tr.querySelectorAll("td").forEach((td,i)=>row[columns[i].dataKey]=td.textContent);
            rows.push(row);
        });
        doc.autoTable({
            head:[columns.map(c=>c.header)],
            body:rows.map(r=>columns.map(c=>r[c.header])),
            styles:{cellPadding:2,fontSize:10},
            headStyles:{fillColor:[240,240,240]},
            columnStyles:{"WQ":{halign:"center"}, "WQ inkl. TF":{halign:"center"}},
            didDrawCell:(data)=>{
                if(data.section==="body" && data.column.index===actionsPositive.length){
                    const {cell} = data;
                    doc.setDrawColor(0);
                    doc.setLineWidth(0.7);
                    doc.line(cell.x,cell.y,cell.x,cell.y+cell.height);
                }
            }
        });
        doc.save(filename);
    }
})();
