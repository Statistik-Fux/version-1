<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Handball Statistik</title>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<style>
body { font-family: Arial, sans-serif; margin: 0; background-color: #fff; }
body::before, body::after {
    content: ""; position: fixed; top: 50%; transform: translateY(-50%);
    width: 70vw; height: 90vh; background-repeat: no-repeat; background-position: center;
    background-size: contain; opacity: 0.15; filter: blur(0.5px);
    z-index: -1; pointer-events: none;
}
body::before { left: 15%; background-image: url('logo.png'); }
body::after { right: 15%; background-image: url('logo.png'); }
h1, h2 { text-align: center; margin-bottom: 15px; }
#setup { background: rgba(255, 255, 255, 0.6); padding: 20px; border-radius: 12px;
    max-width: 500px; margin: 30px auto; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
#opponent, #teamSelect { font-size: 1.1em; padding: 12px; width: 100%; margin-bottom: 20px;
    border: 1px solid #ccc; border-radius: 8px; background-color: rgba(255,255,255,0.85);
    transition: border-color 0.3s, box-shadow 0.3s; color: black;
}
#opponent:focus, #teamSelect:focus { outline: none; border-color: #009688; box-shadow: 0 0 5px rgba(0,150,136,0.5); }
#player-selection { display: flex; gap: 10px; flex-wrap: nowrap; justify-content: space-between; }
#player-selection .column { width: 48%; display: flex; flex-direction: column; gap: 8px; }
#player-selection label { cursor: pointer; font-size: 1em; padding: 4px 0; }
#player-selection input[type="checkbox"] { margin-right: 6px; transform: scale(1.2); }
.add-player-container { margin-top: 15px; display: flex; gap: 5px; }
.add-player-container input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 6px; }
.add-player-container select { margin-left:5px; padding:6px; border-radius:6px; border:1px solid #ccc; }
.add-player-container button { padding: 8px 12px; border: none; border-radius: 6px;
    background-color: #009688; color: white; cursor: pointer; font-size: 1em; }
.add-player-container button:hover { background-color: #00796b; }
.start-btn {
    font-size: 1.3em; padding: 12px 15px; background: linear-gradient(90deg, #009688, #26a69a);
    color: white; border: none; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 20px;
    transition: background 0.3s, transform 0.1s;
}
.start-btn:hover { background: linear-gradient(90deg, #00796b, #26a69a); }
.start-btn:active { transform: scale(0.98); }
.player-card { border-radius: 8px; padding: 10px; margin: 10px; flex: 1; min-width: 250px;
    background: white; box-shadow: 0 3px 8px rgba(0,0,0,0.05); }
.player-name { font-weight: bold; font-size: 1.4em; text-align: center; margin-bottom: 10px; }
.grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; padding: 10px; }
.btn { width: 31%; padding: 8px; margin: 2px 1%; border: none; cursor: pointer;
    font-size: 0.9em; border-radius: 6px; user-select: none; }
.positive { background-color: #d4edda; }
.negative { background-color: #f8d7da; }
.full-width { width: 98%; }
table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: white; font-size: 0.9em; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
th { background: #f0f0f0; }
.thick-separator { border-left: 3px solid black !important; }
.export-buttons { margin-top: 20px; text-align: center; }
.hidden { display: none; }
@media (max-width: 768px) {
    .btn { width: 48%; font-size: 0.85em; padding: 6px; }
    .player-card { min-width: unset; width: 100%; }
    #player-selection { flex-direction: column; }
    #player-selection .column { width: 100%; }
    table { font-size: 0.8em; }
}
</style>
</head>
<body>
<main id="setup">
<h1>Willkommen!</h1>
<input type="text" id="opponent" placeholder="Gegner eingeben">
<select id="teamSelect">
    <option value="Fux2">Fux2</option>
    <option value="FuxA">FuxA</option>
</select>
<section id="player-selection">
    <div class="column" id="col1"></div>
    <div class="column" id="col2"></div>
</section>
<div class="add-player-container">
    <input type="text" id="newPlayerName" placeholder="Spielername eingeben">
    <select id="newPlayerCategory">
        <option value="Rückraum">Rückraum</option>
        <option value="Außen">Außen</option>
        <option value="Kreis">Kreis</option>
        <option value="Torhüter">Torhüter</option>
    </select>
    <button type="button" id="addPlayerBtn">+</button>
</div>
<button class="start-btn" id="startBtn">Start</button>
</main>

<h1 id="headline" class="hidden"></h1>
<div id="players" class="grid"></div>

<div class="export-buttons hidden" id="playerExport">
    <button data-export="excel" data-table="playerTable">Export Excel</button>
    <button data-export="pdf" data-table="playerTable">Export PDF</button>
</div>
<div id="playerStats"></div>

<div class="export-buttons hidden" id="teamExport">
    <button data-export="excel" data-table="teamTable">Export Excel</button>
    <button data-export="pdf" data-table="teamTable">Export PDF</button>
</div>
<div id="teamStats"></div>

<!-- Bibliotheken -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script>
(() => {
    // --- Globale Variablen ---
    window.playersData = {};
    window.currentOpponent = "";
    window.playerNames = [];
    window.playerCategories = [];
    window.actionsPositive = [
        {key:"KM_pos",label:"KM"},
        {key:"DBR_pos",label:"DBR"},
        {key:"AUSSEN_pos",label:"Außen"},
        {key:"NAH_pos",label:"NAH"},
        {key:"FERN_pos",label:"FERN"},
        {key:"TGS_pos",label:"TGS"},
        {key:"LT_pos",label:"Leeres"},
        {key:"7M_pos",label:"7M"}
    ];
    window.actionsNegative = [
        {key:"KM_neg",label:"KM"},
        {key:"DBR_neg",label:"DBR"},
        {key:"AUSSEN_neg",label:"Außen"},
        {key:"NAH_neg",label:"NAH"},
        {key:"FERN_neg",label:"FERN"},
        {key:"TGS_neg",label:"TGS"},
        {key:"LT_neg",label:"Leeres"},
        {key:"7M_neg",label:"7M"},
        {key:"TF_neg",label:"TF"}
    ];

    // --- Teams & Kategorien ---
    const teams = {
        Fux2: ["Julian Kusche","Gabriel Kofler","Lauro Pichiri","Felix Bernkop-Schnürch","Rune Laskowski","Lucas Mohr","Navi Yatawarage","William Reichardt","Justin Wollny","Jan Grüner","Dominik Kupiec","Lennart Steltner","Luca Thiel","Tim Schröder","Jonas Kofler","Till Braren","Pius Joppich","Norman Glamann"],
        FuxA: ["Leo Nowak","Simon Poppe","Fritz Parke","Fynn Paulicks","Filip Dominikovic","Leo Tautenhahn","Antonio D'Incecco","Noah Skei","Simon Sirot","Albert Schmidt","Gabor Zeuch","Christopher Losch","Davide Babini","Tillman Stark","Henning Lahuis","Ole Krake","Matteo Agistonelli"]
    };
    const categories = {
        Fux2: [...Array(8).fill("Rückraum"), ...Array(5).fill("Außen"), ...Array(3).fill("Kreis"), ...Array(2).fill("Torhüter")],
        FuxA: [...Array(8).fill("Rückraum"), ...Array(4).fill("Außen"), ...Array(2).fill("Kreis"), ...Array(3).fill("Torhüter")]
    };

    // --- DOM-Elemente ---
    const col1 = document.getElementById("col1");
    const col2 = document.getElementById("col2");
    const startBtn = document.getElementById("startBtn");
    const teamSelect = document.getElementById("teamSelect");
    const addPlayerBtn = document.getElementById("addPlayerBtn");
    const newPlayerNameInput = document.getElementById("newPlayerName");
    const newPlayerCategorySelect = document.getElementById("newPlayerCategory");

    // --- Initialisierung ---
    window.playerNames = [...teams.Fux2];
    window.playerCategories = [...categories.Fux2];

    const renderPlayerCheckboxes = () => {
        col1.innerHTML = "";
        col2.innerHTML = "";
        window.playerNames.forEach((name, i) => {
            const label = document.createElement("label");
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.value = i + 1;
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(` ${name}`));
            (i < Math.ceil(window.playerNames.length / 2) ? col1 : col2).appendChild(label);
        });
    };

    teamSelect.addEventListener("change", () => {
        window.playerNames = [...teams[teamSelect.value]];
        window.playerCategories = [...categories[teamSelect.value]];
        renderPlayerCheckboxes();
    });

    addPlayerBtn.addEventListener("click", () => {
        const name = newPlayerNameInput.value.trim();
        const cat = newPlayerCategorySelect.value;
        if (!name) return;
        let insertIndex = window.playerCategories.findLastIndex(c => c === cat);
        insertIndex = insertIndex === -1 ? window.playerCategories.length : insertIndex + 1;
        window.playerNames.splice(insertIndex, 0, name);
        window.playerCategories.splice(insertIndex, 0, cat);
        renderPlayerCheckboxes();
        newPlayerNameInput.value = "";
    });

    const validateAndStart = () => {
        const opponent = document.getElementById("opponent").value.trim();
        const selected = Array.from(document.querySelectorAll("#player-selection input:checked"))
            .map(cb => parseInt(cb.value));
        if (!opponent || selected.length < 7) {
            alert("Bitte korrigieren:\n- Gegner eingeben\n- Mindestens 7 Spieler auswählen");
            return;
        }
        window.currentOpponent = opponent;
        window.startGame(opponent, selected);
    };

    startBtn.addEventListener("click", validateAndStart);
    window.renderPlayerCheckboxes = renderPlayerCheckboxes;
    window.addEventListener("load", () => renderPlayerCheckboxes());
})();
</script>
<script>
(() => {
    const playersDiv = document.getElementById("players");
    const headline = document.getElementById("headline");

    function startGame(opponent, selectedPlayers) {
        headline.innerText = `Statistik vs ${opponent}`;
        document.getElementById("setup").classList.add("hidden");
        headline.classList.remove("hidden");
        document.getElementById("playerExport").classList.remove("hidden");
        document.getElementById("teamExport").classList.remove("hidden");
        playersDiv.innerHTML = "";

        selectedPlayers.forEach(num => {
            window.playersData[num] = {};
            [...window.actionsPositive, ...window.actionsNegative].forEach(a => {
                window.playersData[num][a.key] = 0;
                window.playersData[num][a.key + "_temp"] = 0;
            });

            const card = document.createElement("div");
            card.className = "player-card";

            const nameDiv = document.createElement("div");
            nameDiv.className = "player-name";
            nameDiv.textContent = window.playerNames[num-1];
            card.appendChild(nameDiv);

            [...window.actionsPositive, ...window.actionsNegative].forEach((a, idx) => {
                const btn = document.createElement("button");
                btn.className = `btn ${idx < window.actionsPositive.length ? "positive" : "negative"}`;
                if (a.key.startsWith("TF") && idx >= window.actionsPositive.length) btn.classList.add("full-width");
                btn.textContent = `${a.label} (0)`;

                const isFieldPlayer = window.playerCategories[num-1] !== "Torhüter";
                const canAddTempo = (idx < window.actionsPositive.length || a.key === "TF_neg") && isFieldPlayer;

                let pressTimer = null;
                let longPressActive = false;
                let dblClickActive = false;

                const startPress = () => {
                    longPressActive = false;
                    pressTimer = setTimeout(() => {
                        window.playersData[num][a.key] = Math.max(0, window.playersData[num][a.key] - 1);
                        btn.textContent = formatBtnText(num, a);
                        updateTables();
                        longPressActive = true;
                    }, 500);
                };

                const endPress = () => {
                    clearTimeout(pressTimer);
                    if (!longPressActive && !dblClickActive) {
                        window.playersData[num][a.key]++;
                        btn.textContent = formatBtnText(num, a);
                        updateTables();
                    }
                };

                btn.addEventListener("dblclick", () => {
                    dblClickActive = true;
                    if (canAddTempo) {
                        window.playersData[num][a.key]++;
                        window.playersData[num][a.key + "_temp"]++;
                        btn.textContent = formatBtnText(num, a);
                        updateTables();
                    }
                    setTimeout(() => dblClickActive = false, 300);
                });

                btn.addEventListener("mousedown", startPress);
                btn.addEventListener("mouseup", endPress);
                btn.addEventListener("mouseleave", () => clearTimeout(pressTimer));
                btn.addEventListener("touchstart", e => { startPress(); e.preventDefault(); });
                btn.addEventListener("touchend", e => { endPress(); e.preventDefault(); });
                btn.addEventListener("touchcancel", () => clearTimeout(pressTimer));

                card.appendChild(btn);

                if (idx === window.actionsPositive.length - 1) {
                    const sep = document.createElement("div");
                    sep.style.borderBottom = "3px solid black";
                    sep.style.margin = "5px 0";
                    card.appendChild(sep);
                }
            });

            playersDiv.appendChild(card);
        });

        updateTables();
    }

    function formatBtnText(num, a) {
        const val = window.playersData[num][a.key];
        const temp = window.playersData[num][a.key + "_temp"];
        return temp > 0 ? `${a.label} (${val} (${temp}))` : `${a.label} (${val})`;
    }

    window.startGame = startGame;
})();
</script>
<script>
function updateTables() {
    const buildTable = (id, header1, rows) => {
        let extraHeaders = id === "teamTable" ? "<th>Tempotore</th><th>TW</th>" : "";
        let headerRow = `<tr><th>${header1}</th>` +
            window.actionsPositive.map(a => `<th>${a.label}</th>`).join("") +
            window.actionsNegative.map((a,i) => `<th class="${i===0 ? "thick-separator" : ""}">${a.label}</th>`).join("") +
            `<th>WQ</th><th>WQ inkl. TF</th>` + extraHeaders + `</tr>`;
        return `<table id="${id}">${headerRow}${rows}</table>`;
    };

    // --- Spielerstatistik ---
    let playerRows = "";
    let lastCategory = null;
    Object.keys(window.playersData).forEach(num => {
        const cat = window.playerCategories[num-1];
        if (lastCategory && lastCategory !== cat) {
            playerRows += `<tr><td colspan="${window.actionsPositive.length + window.actionsNegative.length + 3 + 2}"></td></tr>`;
        }
        lastCategory = cat;

        const posSum = window.actionsPositive.reduce((s,a)=>s+window.playersData[num][a.key],0);
        const negSumExTF = window.actionsNegative.filter(a=>a.key!=="TF_neg").reduce((s,a)=>s+window.playersData[num][a.key],0);
        const negSum = window.actionsNegative.reduce((s,a)=>s+window.playersData[num][a.key],0);

        playerRows += `<tr><td>${window.playerNames[num-1]}</td>` +
            window.actionsPositive.map(a => {
                const v = window.playersData[num][a.key];
                const t = window.playersData[num][a.key + "_temp"];
                return `<td>${v}${t>0?` (${t})`:""}</td>`;
            }).join("") +
            window.actionsNegative.map((a,i) => {
                const v = window.playersData[num][a.key];
                const t = window.playersData[num][a.key + "_temp"];
                return `<td class="${i===0 ? "thick-separator" : ""}">${v}${(a.key==="TF_neg" && t>0)?` (${t})`:""}</td>`;
            }).join("") +
            `<td>${posSum+negSumExTF>0 ? (posSum/(posSum+negSumExTF)*100).toFixed(1)+"%" : "-"}</td>` +
            `<td>${posSum+negSum>0 ? (posSum/(posSum+negSum)*100).toFixed(1)+"%" : "-"}</td></tr>`;
    });
    document.getElementById("playerStats").innerHTML = buildTable("playerTable", "Spieler", playerRows);

    // --- Teamstatistik ---
    const fieldPlayers = Object.keys(window.playersData).filter(n => window.playerCategories[n-1] !== "Torhüter");
    const goalkeepers = Object.keys(window.playersData).filter(n => window.playerCategories[n-1] === "Torhüter");

    const sumField = (key) => fieldPlayers.reduce((s,n)=>s+window.playersData[n][key],0);
    const sumGK = (key) => goalkeepers.reduce((s,n)=>s+window.playersData[n][key],0);

    const teamRow = `<tr><td>Gesamt</td>` +
        window.actionsPositive.map(a=>`<td>${sumField(a.key)}</td>`).join("") +
        window.actionsNegative.map((a,i)=>`<td class="${i===0?"thick-separator":""}">${sumField(a.key)}</td>`).join("") +
        `<td>${sumField("KM_pos")/ (sumField("KM_pos")+sumField("KM_neg"))*100 || "-"}%</td>` +
        `<td>${sumField("KM_pos")/ (sumField("KM_pos")+sumField("KM_neg")+sumField("TF_neg"))*100 || "-"}%</td>` +
        `<td>${window.actionsPositive.reduce((s,a)=>s+sumField(a.key+"_temp"),0)+sumField("TF_neg_temp")}</td>` +
        `<td>${Math.round(sumGK("KM_pos")/ (sumGK("KM_pos")+sumGK("KM_neg"))*100) || "-"}%</td></tr>`;

    document.getElementById("teamStats").innerHTML = buildTable("teamTable", "Team", teamRow);
}

// ---- Exportfunktionen ----
function exportTableToExcel(tableID) {
    const table = document.getElementById(tableID);
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.table_to_sheet(table, {raw: true});
    XLSX.utils.sheet_add_aoa(ws, [[`Statistik vs ${window.currentOpponent}`]], {origin: "A1"});
    ws['!cols'] = Array(table.rows[0].cells.length).fill({wch: 12});
    XLSX.utils.book_append_sheet(wb, ws, "Stats");
    XLSX.writeFile(wb, `${tableID}.xlsx`);
}

function exportTableToPDF(tableID) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({orientation: 'landscape', unit: 'mm', format: 'a4'});
    doc.setFontSize(16);
    doc.text(`Statistik vs ${window.currentOpponent}`, 14, 15);
    doc.autoTable({
        html: `#${tableID}`,
        startY: 20,
        theme: 'grid',
        styles: { lineWidth: 0.2, lineColor: [0,0,0], halign: 'center', valign: 'middle' },
        headStyles: { fillColor: [240,240,240], textColor: 0, lineWidth: 0.2, lineColor: [0,0,0] },
    });
    doc.save(`${tableID}.pdf`);
}

// ---- Export-Buttons ----
document.querySelectorAll("button[data-export]").forEach(btn => {
    btn.addEventListener("click", e => {
        const type = e.target.getAttribute("data-export");
        const table = e.target.getAttribute("data-table");
        if(type==="excel") exportTableToExcel(table);
        if(type==="pdf") exportTableToPDF(table);
    });
});
</script>
